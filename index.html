<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AutoRemind</title>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="table_style.css" />

    <style>
      :root{
        --olive:#3e5f3a; --olive-dark:#2f472c; --pale:#e7efd9;
        --text:#0e0e0e; --muted:#6b6b6b; --line:#e6e6e6;

        /* alignment controls (keep these in sync with styles below) */
        --dot-size:16px;      /* checkbox visual size */
        --dot-border:2px;     /* border width on the dot */
        --label-gap:10px;     /* gap between dot and label text */
      }
      *{ box-sizing:border-box; }
      html,body{ margin:0; padding:0; }
      body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:#fff; }
      .container{ width:min(1100px,92vw); margin:0 auto; }

      /* Top nav */
      .nav{ position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:18px clamp(16px,4vw,28px); background:#fff; }
      .brand{ font-size:28px; font-weight:700; text-decoration:none; color:var(--text); letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
      .brand img { height:70px; width:auto; }
      .nav__right{ display:flex; gap:22px; align-items:center; }
      .nav__link{ text-decoration:none; color:#111; font-size:15px; }
      .nav__link:hover{ text-decoration:underline; }
      .btn{ border:0; cursor:pointer; font-weight:600; border-radius:999px; padding:10px 16px; }
      .btn--primary{ background:var(--olive); color:#fff; padding:13px 18px; }
      .btn--primary:hover{ background:var(--olive-dark); }

      /* Hero — centered horizontally */
      .hero{
        display:flex; justify-content:center; align-items:center;
        text-align:center; margin:48px 0 24px; width:100%;
      }
      .hero h1{ font-size:clamp(28px,5vw,42px); margin:0; font-weight:500; } /* not bold */

      /* Divider with pill */
      .divider{ position:relative; height:32px; margin:28px 0 20px; }
      .divider::before{ content:""; position:absolute; left:0; right:0; top:50%; height:1px; background:var(--line); transform:translateY(-50%); }
      .pill{ position:absolute; left:50%; transform:translate(-50%,-50%); top:50%; background:var(--pale); color:#263226; font-weight:600; padding:10px 18px; border-radius:999px; white-space:nowrap; box-shadow:0 1px 0 rgba(0,0,0,.04); }

      /* Two columns */
      .grid{ display:grid; gap:40px; align-items:start; grid-template-columns:repeat(2,minmax(0,1fr)); }
      @media (max-width:820px){ .grid{ grid-template-columns:1fr; } }

      .label{ margin:10px 0 12px; font-weight:600; }

      /* Clickable channel options */
      .channels{ list-style:none; padding:0; margin:0; display:grid; gap:12px; }
      .channels li{ display:block; }
      .channels label{ display:flex; align-items:center; gap:var(--label-gap); cursor:pointer; user-select:none; }
      .channels input[type="checkbox"]{
        position:absolute; opacity:0; width:1px; height:1px; overflow:hidden; /* accessible, visually hidden */
      }
      .dot{
        width:var(--dot-size); height:var(--dot-size); border-radius:3px;
        display:inline-block; background:#fff; border:var(--dot-border) solid #cfe2b3;
        transition: all .15s; position: relative;
      }
      .channels input[type="checkbox"]:focus + .dot{ outline:2px solid #cfe2b3; outline-offset:2px; }
      .channels input[type="checkbox"]:checked + .dot{
        background:var(--olive); border-color:var(--olive);
      }
      .channels input[type="checkbox"]:checked + .dot::after{
        content:"✓"; position:absolute; color:#fff; font-size:12px; top:50%; left:50%; transform:translate(-50%,-50%);
      }

      /* Channel text fields (appear under toggles) */
      .channel-field{
        display:none;            /* shown via JS when checked */
        width:100%;
        margin:8px 0 0 0;        /* removed left margin to align with checkbox */
        padding:10px 12px;
        font-size:15px;
        border:1px solid var(--line);
        border-radius:10px;
      }
      .channel-field:focus{
        outline:2px solid #cfe2b3;
        border-color:#cfe2b3;
      }

      /* Slider + number input */
      .slider-row{ display:flex; align-items:center; gap:16px; margin-top:8px; }
      .minmax{ font-size:14px; color:#333; }
      input[type="range"]{ -webkit-appearance:none; width:100%; height:4px; background:var(--line); border-radius:999px; outline:none; }
      input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--pale); border:2px solid var(--olive); }
      input[type="range"]::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:var(--pale); border:2px solid var(--olive); }

      .days-input-row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
      .num-input{
        width:72px; appearance:textfield; -moz-appearance:textfield;
        padding:8px 10px; border:1px solid var(--line); border-radius:10px;
        font-size:15px;
      }
      .num-input:focus{ outline:2px solid #cfe2b3; border-color:#cfe2b3; }

      .cta-wrap{ display:flex; justify-content:center; margin:145px 0 36px; }
      .btn--cta{ background:var(--olive); color:#fff; padding:12px 22px; border-radius:999px; font-size:16px; }
      .btn--cta:hover{ background:var(--olive-dark); }

      /* Big green arc */
      .arc-bg{ position:fixed; left:50%; transform:translateX(-50%); bottom:-35vh; width:130vw; height:60vh; border-radius:50% 50% 0 0 / 100% 100% 0 0; background:var(--pale); z-index:-1; }

      /* Footer (renamed to avoid theme's blue .footer) */
      .site-footer{ text-align:center; margin:8px auto 36px; background:transparent !important; }
      .site-footer small, .site-footer small *{ outline:none; border:none; background:transparent; box-shadow:none; }
      .thanks{ color:var(--olive-dark); font-weight:600; }
      .feedback{ color:var(--olive); }
    </style>
  </head>

  <body>
    <!-- Top Nav -->
    <header class="nav">
      <div class="nav__left">
        <a class="brand" href="./login.html"><img src="logo.png" alt="AutoRemind Logo">AutoRemind</a>
      </div>
      <nav class="nav__right">
        <a href="./about.html" class="nav__link">About Us</a>
        <a href="mailto:autoremind@berkeley.edu" class="btn btn--primary" style="text-decoration:none;">Contact Us</a>
      </nav>
    </header>

    <!-- Hero -->
    <section class="hero">
      <h1>Never miss an assignment.</h1>
    </section>

    <!-- Content -->
    <section class="container">
      <div class="grid">
        <!-- Left column -->
        <div>
          <div class="divider"><span class="pill">Reminder Channels</span></div>
          <p class="label">Turn reminders on via:</p>

          <ul class="channels">
            <li>
              <label for="ch-discord">
                <input id="ch-discord" type="checkbox" name="channel_discord" />
                <span class="dot" aria-hidden="true"></span>
                <span>Discord</span>
              </label>
              <!-- revealed on check -->
              <input id="discord-field" class="channel-field" type="text" name="discord_username" placeholder="Enter Discord username" inputmode="text" />
            </li>
            <li>
              <label for="ch-sms">
                <input id="ch-sms" type="checkbox" name="channel_sms" />
                <span class="dot" aria-hidden="true"></span>
                <span>SMS</span>
              </label>
              <!-- revealed on check -->
              <input id="sms-field" class="channel-field" type="tel" name="sms_number" placeholder="Enter phone number" inputmode="tel" />
            </li>
            <li>
              <label for="ch-email">
                <input id="ch-email" type="checkbox" name="channel_email" />
                <span class="dot" aria-hidden="true"></span>
                <span>Email</span>
              </label>
              <!-- revealed on check -->
              <input id="email-field" class="channel-field" type="email" name="email_address" placeholder="Enter email address" inputmode="email" />
            </li>
          </ul>

            <div class="divider" style="margin-top:32px;"><span class="pill">Assignment Status</span></div>
            <ul class="channels">
              <li>
                <label for="ch-incomplete">
                  <input id="ch-incomplete" type="checkbox" name="include_incomplete" />
                  <span class="dot" aria-hidden="true"></span>
                  <span>Include Incomplete Assignments</span>
                </label>
              </li>
            </ul>
        </div>

        <!-- Right column -->
        <div>
          <div class="divider"><span class="pill">Frequency &amp; Timing</span></div>

          <div class="days-input-row">
            <label for="days" class="label" style="margin:0;">Send reminder</label>
            <input id="days" class="num-input" type="number" name="days_before" min="0" max="7" value="5" />
            <span>days before deadline.</span>
          </div>

          <div class="slider-row" style="margin-top:14px;">
            <span class="minmax">0</span>
            <input
              id="days-range"
              type="range" min="0" max="7" value="5"
              oninput="document.getElementById('days').value=this.value"
            />
            <span class="minmax">7</span>
          </div>
          <script>
            // keep number input and slider in sync both ways
            const num = document.getElementById('days');
            const rng = document.getElementById('days-range');
            num.addEventListener('input', () => {
              const v = Math.min(7, Math.max(0, Number(num.value||0)));
              num.value = v; rng.value = v;
            });
          </script>
        </div>
      </div>

      <div class="cta-wrap">
        <button class="btn btn--cta">AutoRemind Me!</button>
      </div>
    </section>

      <!-- Agreement Popup Modal -->
      <div id="agreement-modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.32); justify-content:center; align-items:center;">
        <div style="background:#fff; border-radius:16px; max-width:90vw; width:400px; padding:32px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.18); text-align:center;">
          <h2 style="margin-top:0;">Agreement Required</h2>
          <p style="font-size:16px;">Do you consent to receive informational messages & alerts from AutoRemind?</p>
          <p style="font-size:13px; color:#555; margin-bottom:24px;">Message frequency varies. <br> Message & data rates may apply. <br> <br> Note: You can cancel any time by clicking "Unsubscribe" at the bottom of this page.</p>
          <button id="agree-btn" style="background:var(--olive); color:#fff; border:none; border-radius:8px; padding:10px 22px; font-size:15px; margin-right:10px; cursor:pointer;">I Agree</button>
          <button id="cancel-btn" style="background:#eee; color:#222; border:none; border-radius:8px; padding:10px 22px; font-size:15px; cursor:pointer;">Cancel</button>
        </div>
      </div>

    <!-- Arc + footer -->
    <div class="arc-bg"></div>
    <footer class="site-footer container">
      <small>
        <span class="thanks">Thanks for trying our tool.</span>
        <span class="feedback"> Share your feedback to help us improve.</span><br>
        <a href="#" id="unsubscribe-link" style="text-decoration: underline; color: var(--olive); margin-top: 8px; display: inline-block;">Unsubscribe</a>
      </small>
    </footer>

  <!-- Unsubscribe Popup Modal -->
  <div id="unsubscribe-modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.32); justify-content:center; align-items:center;">
    <div style="background:#fff; border-radius:16px; max-width:90vw; width:400px; padding:32px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.18); text-align:center;">
      <h2 style="margin-top:0;">Unsubscribe</h2>
      <p style="font-size:16px;">Please select the platforms you would like to stop receiving notifications on:</p>
      <form id="unsubscribe-form" style="margin-bottom:18px;">
        <label style="display:block; margin:8px 0; text-align:left;"><input type="checkbox" name="platform" value="discord"> Discord</label>
        <label style="display:block; margin:8px 0; text-align:left;"><input type="checkbox" name="platform" value="sms"> SMS</label>
        <label style="display:block; margin:8px 0; text-align:left;"><input type="checkbox" name="platform" value="email"> Email</label>
        <label style="display:block; margin:12px 0 8px; text-align:left; font-weight:600;"><input type="checkbox" name="platform" value="all"> Turn off all notifications</label>
      </form>
      <p style="font-size:13px; color:#555; margin-bottom:24px;">You are free to re-register for notifications through AutoRemind at any time.</p>
      <button id="unsubscribe-confirm" style="background:var(--olive); color:#fff; border:none; border-radius:8px; padding:10px 22px; font-size:15px; margin-right:10px; cursor:pointer;">Unsubscribe</button>
      <button id="unsubscribe-cancel" style="background:#eee; color:#222; border:none; border-radius:8px; padding:10px 22px; font-size:15px; cursor:pointer;">Cancel</button>
    </div>
  </div>

    <!-- Toggle -> input reveal logic -->
    <script>
      function bindToggle(checkboxId, fieldId){
        const cb = document.getElementById(checkboxId);
        const field = document.getElementById(fieldId);
        const update = () => {
          const enabled = cb.checked;
          field.style.display = enabled ? 'block' : 'none';
          field.disabled = !enabled;
          if(enabled) field.focus();
        };
        cb.addEventListener('change', update);
        // initialize on load in case boxes are pre-checked
        update();
      }
      const channelConfigs = [
        {
          checkboxId: 'ch-discord',
          fieldId: 'discord-field',
          key: 'discord',
          validate: value => value.trim().length > 0,
          errorMessage: 'Please enter a Discord username.'
        },
        {
          checkboxId: 'ch-sms',
          fieldId: 'sms-field',
          key: 'sms',
          validate: value => /^\+?[0-9\s().-]{7,}$/.test(value.trim()),
          errorMessage: 'Please enter a valid phone number for SMS.'
        },
        {
          checkboxId: 'ch-email',
          fieldId: 'email-field',
          key: 'email',
          validate: value => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value.trim()),
          errorMessage: 'Please enter a valid email address.'
        }
      ];
      channelConfigs.forEach(({ checkboxId, fieldId }) => bindToggle(checkboxId, fieldId));

      const includeIncompleteToggle = document.getElementById('ch-incomplete');
      const agreementModal = document.getElementById('agreement-modal');

        // Agreement popup logic for AutoRemind Me button
        const autoRemindBtn = document.querySelector('.btn--cta');
        autoRemindBtn.addEventListener('click', function(e) {
          e.preventDefault();
          agreementModal.style.display = 'flex';
        });
        function collectSettingsPayload(){
          // Re-query locally so we don't depend on another <script> block's scope
          const numEl = document.getElementById('days');
          const rngEl = document.getElementById('days-range');
          const includeIncompleteToggle = document.getElementById('ch-incomplete');

          const clamp = v => Math.min(7, Math.max(0, Number(v || 0)));

          const payload = {
            channels: {},                                      // will hold only enabled channels
            days_before: clamp(numEl.value),
            include_incomplete: includeIncompleteToggle.checked
          };

          if (Number.isNaN(payload.days_before)) payload.days_before = 0;
          payload.days_before = Math.round(payload.days_before);
          numEl.value = payload.days_before;                   // keep UI in sync
          rngEl.value = payload.days_before;

          // Validate enabled channels and collect their values
          let anyChannel = false;
          for (const { checkboxId, fieldId, key, validate, errorMessage } of channelConfigs) {
            const checkbox = document.getElementById(checkboxId);
            const field = document.getElementById(fieldId);
            if (checkbox.checked) {
              anyChannel = true;
              const value = (field.value || '').trim();
              if (!validate(value)) {
                alert(errorMessage);
                field.focus();
                throw new Error('validation');
              }
              payload.channels[key] = value;                   // e.g., { discord: "Lance#1234" }
            }
          }

          if (!anyChannel) {
            alert('Select at least one reminder channel.');
            throw new Error('validation');
          }

          return payload;
        }

        document.getElementById('agree-btn').addEventListener('click', async function() {
          let payload;
          try{
            payload = collectSettingsPayload();
          } catch (err){
            if(err.message === 'validation'){
              return;
            }
            console.error(err);
            alert('There was a problem preparing your reminder settings. Please try again.');
            return;
          }
          try{
            const response = await fetch('/api/reminders/settings', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if(!response.ok){
              const errorData = await response.json().catch(() => ({}));
              console.error('API Error:', response.status, errorData);
              throw new Error(errorData.error || 'request failed');
            }
            const result = await response.json();
            console.log('Success:', result);
            agreementModal.style.display = 'none';
          } catch (err){
            console.error('Error:', err);
            alert('There was a problem saving your reminder settings: ' + err.message);
          }
        });
        document.getElementById('cancel-btn').addEventListener('click', function() {
          agreementModal.style.display = 'none';
        });

          // Unsubscribe popup logic
          const unsubscribeLink = document.getElementById('unsubscribe-link');
          const unsubscribeModal = document.getElementById('unsubscribe-modal');
          const unsubscribeCancel = document.getElementById('unsubscribe-cancel');
          const unsubscribeConfirm = document.getElementById('unsubscribe-confirm');
          unsubscribeLink.addEventListener('click', function(e) {
            e.preventDefault();
            unsubscribeModal.style.display = 'flex';
          });
          unsubscribeCancel.addEventListener('click', function() {
            unsubscribeModal.style.display = 'none';
          });
          unsubscribeConfirm.addEventListener('click', async function() {
            const selectedPlatforms = Array.from(document.querySelectorAll('#unsubscribe-form input[type="checkbox"]:checked')).map(input => input.value);
            if(selectedPlatforms.length === 0){
              alert('Please select at least one platform to unsubscribe from.');
              return;
            }
            try{
              const response = await fetch('/api/reminders/unsubscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ platforms: selectedPlatforms })
              });
              if(!response.ok){
                throw new Error('request failed');
              }
              unsubscribeModal.style.display = 'none';
              alert('Your unsubscribe preferences have been saved.');
            } catch (err){
              alert('There was a problem updating your unsubscribe preferences. Please try again.');
            }
          });
    </script>
  </body>
</html>
